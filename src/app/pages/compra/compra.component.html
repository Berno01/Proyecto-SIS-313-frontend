<div class="compra-container">
  <!-- Breadcrumb / Botón Volver -->
  <div class="breadcrumb">
    <button class="btn-back" (click)="volverAlHistorial()">← Volver al Historial</button>
  </div>

  <div class="page-header">
    <h1>{{ modoEdicion ? 'Editar Compra #' + compraId : 'Nueva Compra' }}</h1>
  </div>

  <!-- Mensajes -->
  <div *ngIf="error" class="alert alert-error">
    {{ error }}
  </div>

  <div *ngIf="successMessage" class="alert alert-success">
    {{ successMessage }}
  </div>

  <!-- Formulario Principal -->
  <form [formGroup]="compraForm" class="compra-form">
    <!-- Información del Proveedor -->
    <div class="form-section">
      <h2>Información del Proveedor</h2>

      <div class="form-group">
        <label for="nombre_proveedor">Nombre del Proveedor *</label>
        <input
          type="text"
          id="nombre_proveedor"
          formControlName="nombre_proveedor"
          class="form-control"
          [class.invalid]="
            compraForm.get('nombre_proveedor')?.invalid &&
            compraForm.get('nombre_proveedor')?.touched
          "
          placeholder="Ingrese el nombre del proveedor"
        />
        <div
          *ngIf="
            compraForm.get('nombre_proveedor')?.invalid &&
            compraForm.get('nombre_proveedor')?.touched
          "
          class="validation-error"
        >
          <span *ngIf="compraForm.get('nombre_proveedor')?.hasError('required')">
            El nombre del proveedor es requerido
          </span>
          <span *ngIf="compraForm.get('nombre_proveedor')?.hasError('minlength')">
            El nombre debe tener al menos 3 caracteres
          </span>
        </div>
      </div>
    </div>

    <!-- Detalle de Compra -->
    <div class="form-section">
      <div class="section-header">
        <h2>Detalle de Compra</h2>
        <button type="button" class="btn btn-add" (click)="abrirModalRepuestos()">
          + Agregar Repuesto
        </button>
      </div>

      <!-- Lista de Repuestos -->
      <div class="detalle-lista">
        <div *ngIf="detalleCompra.length === 0" class="empty-state">
          <p>No hay repuestos agregados</p>
          <p class="hint">Haga clic en "Agregar Repuesto" para comenzar</p>
        </div>

        <app-detalle-compra-item
          *ngFor="let detalle of detalleCompra; let i = index"
          [detalle]="detalle"
          [repuesto]="getRepuesto(detalle.id_repuesto)"
          [index]="i"
          (detalleChange)="onDetalleChange()"
          (eliminar)="eliminarItem($event)"
        ></app-detalle-compra-item>
      </div>
    </div>

    <!-- Resumen de Totales -->
    <div class="form-section totales-section" *ngIf="detalleCompra.length > 0">
      <div class="totales-grid">
        <div class="total-row total-final">
          <span class="total-label">TOTAL:</span>
          <span class="total-value-final">${{ totalCompra.toFixed(2) }}</span>
        </div>
      </div>
    </div>

    <!-- Botones de Acción -->
    <div class="form-actions">
      <button type="button" class="btn btn-cancel" (click)="cancelar()" [disabled]="loading">
        Cancelar
      </button>

      <button
        type="button"
        class="btn btn-submit"
        (click)="guardarCompra()"
        [disabled]="loading || detalleCompra.length === 0"
      >
        <span *ngIf="!loading">{{ modoEdicion ? 'Actualizar Compra' : 'Guardar Compra' }}</span>
        <span *ngIf="loading">{{ modoEdicion ? 'Actualizando...' : 'Guardando...' }}</span>
      </button>
    </div>
  </form>

  <!-- Modal de Repuestos -->
  <app-modal-repuestos-compra
    *ngIf="mostrarModal"
    (close)="cerrarModal()"
    (repuestoAgregado)="agregarRepuestoAlDetalle($event)"
  ></app-modal-repuestos-compra>
</div>
