<div class="modal-overlay" (click)="cerrarModal()">
  <div class="modal-container" (click)="$event.stopPropagation()">
    <!-- Header -->
    <div class="modal-header">
      <h2>{{ repuestoSeleccionado ? 'Detalle del Repuesto' : 'Seleccionar Repuesto' }}</h2>
      <button class="btn-close" (click)="cerrarModal()">&times;</button>
    </div>

    <!-- Body -->
    <div class="modal-body">
      <!-- Loading State -->
      <div *ngIf="loading" class="loading">
        <div class="spinner"></div>
        <p>Cargando...</p>
      </div>

      <!-- Error Message -->
      <div *ngIf="error" class="error-message">
        {{ error }}
      </div>

      <!-- Lista de Repuestos -->
      <div *ngIf="!repuestoSeleccionado && !loading" class="lista-repuestos">
        <!-- Buscador -->
        <div class="search-box">
          <input
            type="text"
            [(ngModel)]="searchTerm"
            (ngModelChange)="filtrarRepuestos()"
            placeholder="Buscar repuesto..."
            class="search-input"
          />
        </div>

        <!-- Tabla de Repuestos -->
        <div class="table-container">
          <table class="repuestos-table">
            <thead>
              <tr>
                <th>Nombre</th>
                <th>Stock</th>
                <th>Precio Sugerido</th>
                <th>Acción</th>
              </tr>
            </thead>
            <tbody>
              <tr
                *ngFor="let repuesto of repuestosFiltrados"
                [class.sin-stock]="repuesto.stockRepuesto === 0"
              >
                <td>{{ repuesto.nombreRepuesto}}</td>
                <td>
                  <span [class.stock-bajo]="repuesto.stockRepuesto < 5">
                    {{ repuesto.stockRepuesto }}
                  </span>
                </td>
                <td>${{ repuesto.precioSugerido.toFixed(2) }}</td>
                <td>
                  <button
                    class="btn-seleccionar"
                    (click)="seleccionarRepuesto(repuesto)"
                    [disabled]="repuesto.stockRepuesto === 0"
                  >
                    Seleccionar
                  </button>
                </td>
              </tr>
              <tr *ngIf="repuestosFiltrados.length === 0">
                <td colspan="4" class="no-results">No se encontraron repuestos</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Detalle del Repuesto Seleccionado -->
      <div *ngIf="repuestoSeleccionado && !loading" class="detalle-repuesto">
        <button class="btn-volver" (click)="volverALista()">← Volver a la lista</button>

        <div class="info-repuesto">
          <h3>{{ repuestoSeleccionado.nombreRepuesto }}</h3>
          <div class="info-grid">
            <div class="info-item">
              <span class="label">Stock Disponible:</span>
              <span class="value">{{ repuestoSeleccionado.stockRepuesto }}</span>
            </div>
            <div class="info-item">
              <span class="label">Precio Sugerido:</span>
              <span class="value precio"
                >${{ repuestoSeleccionado.precioSugerido.toFixed(2) }}</span
              >
            </div>
          </div>
        </div>

        <!-- Formulario -->
        <form [formGroup]="detalleForm" class="detalle-form">
          <div class="form-group">
            <label for="cantidad">Cantidad *</label>
            <input
              type="number"
              id="cantidad"
              formControlName="cantidad"
              min="1"
              [max]="repuestoSeleccionado.stockRepuesto"
              class="form-control"
              [class.invalid]="
                detalleForm.get('cantidad')?.invalid && detalleForm.get('cantidad')?.touched
              "
            />
            <div
              *ngIf="detalleForm.get('cantidad')?.invalid && detalleForm.get('cantidad')?.touched"
              class="validation-error"
            >
              <span *ngIf="detalleForm.get('cantidad')?.hasError('required')"
                >La cantidad es requerida</span
              >
              <span *ngIf="detalleForm.get('cantidad')?.hasError('min')"
                >La cantidad debe ser al menos 1</span
              >
              <span *ngIf="detalleForm.get('cantidad')?.hasError('max')">
                La cantidad no puede exceder el stock ({{ repuestoSeleccionado.stockRepuesto }})
              </span>
            </div>
          </div>

          <div class="form-group">
            <label for="precio_unitario">Precio Unitario *</label>
            <input
              type="number"
              id="precio_unitario"
              formControlName="precio_unitario"
              min="0.01"
              step="0.01"
              class="form-control"
              [class.invalid]="
                detalleForm.get('precio_unitario')?.invalid &&
                detalleForm.get('precio_unitario')?.touched
              "
            />
            <small class="hint"
              >Precio sugerido: ${{
                repuestoSeleccionado.precioSugerido.toFixed(2)
              }}</small
            >
            <div
              *ngIf="
                detalleForm.get('precio_unitario')?.invalid &&
                detalleForm.get('precio_unitario')?.touched
              "
              class="validation-error"
            >
              <span *ngIf="detalleForm.get('precio_unitario')?.hasError('required')"
                >El precio es requerido</span
              >
              <span *ngIf="detalleForm.get('precio_unitario')?.hasError('min')"
                >El precio debe ser mayor a 0</span
              >
            </div>
          </div>

          <div class="subtotal-display">
            <span class="subtotal-label">Subtotal:</span>
            <span class="subtotal-value">${{ subtotal.toFixed(2) }}</span>
          </div>
        </form>
      </div>
    </div>

    <!-- Footer -->
    <div class="modal-footer" *ngIf="repuestoSeleccionado && !loading">
      <button class="btn btn-secondary" (click)="cerrarModal()">Cancelar</button>
      <button class="btn btn-primary" (click)="agregarRepuesto()" [disabled]="detalleForm.invalid">
        Agregar
      </button>
    </div>
  </div>
</div>
